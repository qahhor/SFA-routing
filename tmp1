# Routing service
These routing services are implemented based on [**Google Or-Tools**](https://developers.google.com/optimization/routing).
---

This procedure calls routing service and returns results to the front end.

> [Traveling Salesperson Problem](#traveling-salesperson-problem) - *“routing server URL” + “/api/v1*.
>
>
> [Vehicle Routing Problem with Capacity Constrains](#vehicle-routing-problem-with-capacity-constraints-service) - *“routing server URL” + “/vrpc”*.
>
> [Error code definitions](#error-code-definitions)

---
## Traveling Salesperson Problem
This service generates a route for a salesperson who must visit a number of points each day for four weeks. The salesperson can start and ends the trip at any point. The service calculates the route based on the time to travel between points and the time spent at each point. The service returns the route with the minimum time spent on the road. The service considers the following constraints:

- Maximum number of points in the daily route.
- Working hours in a day in seconds.
- Visit duration at each point.
- Intensity of visits at each point.

Intensities of visits at each point:

- THEE_TIMES_A_WEEK
- TWICE_A_WEEK
- ONCE_A_WEEK
- TWICE_A_MONTH
- ONCE_A_MONTH

Time spent on the road calculated with the [OSRM](https://github.com/Project-OSRM/osrm-backend/blob/master/docs/http.md) based on the profile of the vehicle. The service uses the following profiles:

- driving
- walking
- cycling

### This service separated into three kind
> ***auto*** - for generating multiple plans. Algorithm geneartes optimal number of plans.
>
> ***single*** - for generating single plan.
>
> ***manual*** - not implemented.


Input data format for the service
```json
{
  "kind": "auto",
  "data": {
    ...
  }
}
```

Definitions of input data

> **kind:** Kind of the service. Kind could be ***auto***, ***single*** or ***manual***.
>
> **data:** Data for the spesific kind.

Data format for the kind ***auto*** and ***single***
```json
{
  "locations": [
    {
      "lat": "62.512341",
      "lng": "41.234255",
      "visit_duration": 600,
      "visit_intensity": "THREE_TIMES_A_WEEK"
    }
  ],

  "map_url": "https://map-route-car.greenwhite.uz",

  "profile": "driving",

  "max_visit_limit_per_day": 20,

  "working_seconds_per_day": 25000
}
```

Definitions of data for the kind ***auto*** and ***single***

> **locations:** List of points to be visited by the salesperson.
>
> **lat_lng:** Location coordinate with precision 6.
>
> **visit_duration:** Visit duration at each point in seconds.
>
> **visit_intensity:** Intensity of visits at each point.
>
> **map_url:** URL of server which service gets a table of the distances for vehicle.
>
> **profile:** Profile of the vehicle.
>
> **max_visit_limit_per_day:** Maximum number of points in the daily route.
>
> **working_seconds_per_day:** Working hours in a day in seconds.

Result data format for the kind ***auto***
```json
{
  "code": 100,

  "plans": [
    [ // plan for four weeks
      [ // paln for a week
        [2, 5, 4], // plan for the day
        [1, 7, 3, 6],
        ...
      ],
      [
        [2, 5, 4],
        [1, 7, 3, 6],
        ...
      ]
      ...
    ]
  ],

  "error_text": "No solution found to the problem"
}
```

Definitions of result data:

> **code:** Result code. 100 - success, others - error.
>
> **plans:** List of plans. Each plan contains a list of routes for four weeks. Routes for each week are represented as a list of lists. Each list contains indexes of locations in the order of visiting for the specific day.
>
> **error_text:** Displayed when code is not equal to 100.

Result data format for the kind ***single***
```json
{
  "code": 100,

  "routes": [
    [
      [2, 5, 4],
      [1, 7, 3, 6],
      ...
    ],
    [
      [2, 5, 4],
      [1, 7, 3, 6],
      ...
    ]
    ...
  ],

  "ignored_locations": [8, 9],

  "error_text": "No solution found to the problem"
}
```

Definitions of result data:

> **code:** Result code. 100 - success, others - error.
>
> **routes:** List of routes for four weeks. Routes for each week are represented as a list of lists. Each list contains indexes of locations in the order of visiting for the specific day.
>
> **ignored_locations:** List of indexes of locations which are ignored by the service.
>
> **error_text:** Displayed when code is not equal to 100.

---

## Vehicle Routing Problem with Capacity Constraints service
Input data format for **VRPC** service *(**V**ehicle **R**outing **P**roblem **C**apacity constraints)*:

```json
{
  "depot": {
    "lat": "61.236212",
    "lng": "42.623415"
  },

  "points": [
    {
      "lat": "62.512341",
      "lng": "41.234255",
      "weight": 12
    }
  ],

  "vehicles": [
    {
      "type": "truck",
      "capacity": 100
    }
  ],

  "max_cycle_distance": 75000,

  "global_span_coefficient": 30,

  "urls": {
    "car": "https://map-route-car.greenwhite.uz",
    "truck": "https://map-route-truck.greenwhite.uz",
    "walking": "https://map-route-foot.greenwhite.uz",
    "cycling": "https://map-route-bike.greenwhite.uz"
  }
}
```

>**Definitions of VRPC input data**
>> **depot:** The location where cars start and end their trip.
>>
>> **lat_lng:** Location coordinate with precision 6.
>>
>> **points:** Points where the goods should be delivered.
>>
>> **vehicles:** Vehicles carrying goods.
>>
>> **weight:** Weight of cargo.
>>
>> **type:** Type of vehicle, type must be one of [car, truck, walking, cycling].
>>
>> **max_cycle_distance:** Optional. Default 1e18. Maximum distance for each cycle.
>>
>> **global_span_coefficient:** Optional. This coefficient should be in (1-100). Default is 30. It is balance between (minimum total distance) and (minimum overall time).
>>
>>  **urls:** Key-value pairs of URLs, the key is a type of the vehicle, the value is URL which service gets a table of the distances for vehicle.

---

Output data format for **VRPC** service:

```json
{
  "code": 100,

  "vehicles": [
    [
      {
        "route": [2, 5, 4],
        "distance": 12423,
        "duration": 52
      },
      {
        "route": [1, 7],
        "distance": 12423,
        "duration": 52
      }
    ],
    [
      {
        "route": [3, 6],
        "distance": 42423,
        "duration": 184
      }
    ]
  ],

  "total_distance": 56230,

  "total_duration": 245,

  "error_text": "No solution found to the problem"
}
```

>**Definitions of VRPC output data**
>> **code:** Result status code, 100 - success, others - error.
>>
>> **vehicles:** List of vehicles ordered by input format's order. Each element of the vehicles list is a vehicle that contains loop objects. Each vehicle may have multiple loops.
>>
>> **route:** List of points which vehicle should visit for a trip.
>>
>> **total_distance:** VTotal distance in meters.
>>
>> **total_duration:** Total duration in seconds.
>>
>> **error_text:** Displayed when code is not equal to 100.


---

# Error code definitions
> **100:** Success.
>
> **101:** Invalid input format.
>
> **102:** Unsupported vehicle type.
>
> **103:** Url not found for vehicle type.
>
> **104:** An error occurred while connecting to the specified OSRM URL.
>
> **105:** OSRM server couldn't generate distance matrix from given locations.
>
> **106:** The weight of the load exceeds the carrying capacity of the vehicle.
>
> **107:** The cost of the arc for the vehicle has not been set.
>
> **108:** Time limit reached before finding a solution.
>
> **109:** No solution found to the problem.
>
> **110:** Unexpected error.
>
> **111:** Out of memory.
