# SFA-Routing: Use Cases (–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–∏–ø–∏—á–Ω—ã–µ –±–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ API.

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ù–µ–¥–µ–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ SFA](#1-–Ω–µ–¥–µ–ª—å–Ω–æ–µ-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ-sfa)
2. [–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∞–≥–µ–Ω—Ç–∞](#2-–µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è-—Ä–∞–±–æ—Ç–∞-–∞–≥–µ–Ω—Ç–∞)
3. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏](#3-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è-–¥–æ—Å—Ç–∞–≤–∫–∏)
4. [–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è](#4-–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è-–ø–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
5. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ERP](#5-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-erp)
6. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ–ª–æ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏](#6-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-—Ñ–ª–æ—Ç–∞-–≤-—Ä–µ–∞–ª—å–Ω–æ–º-–≤—Ä–µ–º–µ–Ω–∏)

---

## 1. –ù–µ–¥–µ–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ SFA

### –ë–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞
–ö–∞–∂–¥—É—é –ø—è—Ç–Ω–∏—Ü—É –¥–∏—Å–ø–µ—Ç—á–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –¥–ª—è 20+ —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π, —É—á–∏—Ç—ã–≤–∞—è:
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ (A: 2-3 —Ä–∞–∑–∞/–Ω–µ–¥–µ–ª—é, B: 1 —Ä–∞–∑, C: —Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏)
- –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é –±–ª–∏–∑–æ—Å—Ç—å —Ç–æ—á–µ–∫
- –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (–æ–±–µ–¥, –ø—è—Ç–Ω–∏—á–Ω–∞—è –º–æ–ª–∏—Ç–≤–∞)

### API Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü—è—Ç–Ω–∏—Ü–∞ –≤–µ—á–µ—Ä  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ POST /planning/ ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫    ‚îÇ
‚îÇ  –î–∏—Å–ø–µ—Ç—á–µ—Ä      ‚îÇ     ‚îÇ     weekly      ‚îÇ     ‚îÇ  –ê–≥–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç‚îÇ
‚îÇ  –∑–∞–ø—É—Å–∫–∞–µ—Ç      ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ  –ø–ª–∞–Ω—ã          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ó–∞–ø—Ä–æ—Å—ã

```bash
# 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞
POST /api/v1/planning/weekly
{
  "agent_id": "uuid-–∞–≥–µ–Ω—Ç–∞",
  "week_start_date": "2024-02-05",
  "include_high_priority": true,
  "respect_categories": true
}

# –û—Ç–≤–µ—Ç:
{
  "agent_id": "...",
  "week_start": "2024-02-05",
  "week_end": "2024-02-09",
  "daily_plans": [
    {
      "date": "2024-02-05",
      "visits_count": 12,
      "total_distance_km": 35.5,
      "visits": [
        {
          "sequence": 1,
          "client_id": "...",
          "client_name": "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç –ú–∞–∫—Ä–æ",
          "category": "A",
          "planned_time": "09:15",
          "duration_minutes": 25
        },
        ...
      ]
    },
    ...
  ],
  "summary": {
    "total_visits": 58,
    "a_class_visits": 15,
    "b_class_visits": 35,
    "c_class_visits": 8,
    "total_distance_km": 180.5
  }
}

# 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –Ω–∞ –¥–µ–Ω—å (–¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞)
GET /api/v1/planning/agent/{agent_id}/day/2024-02-05

# 3. –≠–∫—Å–ø–æ—Ä—Ç –ø–ª–∞–Ω–∞ –≤ PDF
GET /api/v1/export/daily-plan/{agent_id}/2024-02-05
# ‚Üí application/pdf
```

---

## 2. –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∞–≥–µ–Ω—Ç–∞

### –ë–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞
–ê–≥–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–∏–∑–∏—Ç—ã –ø–æ –ø–ª–∞–Ω—É, –æ—Ç–º–µ—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Å–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç GPS.

### API Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£—Ç—Ä–æ    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ –í–∏–∑–∏—Ç 1  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ –í–∏–∑–∏—Ç 2  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  –í–µ—á–µ—Ä   ‚îÇ
‚îÇ GET –ø–ª–∞–Ω ‚îÇ    ‚îÇ PATCH    ‚îÇ    ‚îÇ PATCH    ‚îÇ    ‚îÇ –û—Ç—á—ë—Ç    ‚îÇ
‚îÇ          ‚îÇ    ‚îÇ complete ‚îÇ    ‚îÇ skip     ‚îÇ    ‚îÇ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ               ‚îÇ               ‚îÇ
      ‚ñº               ‚ñº               ‚ñº
   WebSocket GPS updates –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
```

### –ó–∞–ø—Ä–æ—Å—ã

```bash
# 1. –£—Ç—Ä–æ: –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
GET /api/v1/planning/agent/{agent_id}/day/2024-02-05

# 2. WebSocket: —Å—Ç—Ä–∏–º–∏–Ω–≥ GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
WS /ws/agents/{agent_id}
# –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫:
{
  "type": "gps_update",
  "latitude": 41.315,
  "longitude": 69.285,
  "timestamp": "2024-02-05T10:30:00Z"
}

# 3. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞
PATCH /api/v1/planning/visits/{visit_id}
{
  "status": "completed",
  "actual_time": "10:45",
  "actual_duration_minutes": 20,
  "notes": "–ó–∞–∫–∞–∑ —Ä–∞–∑–º–µ—â—ë–Ω –Ω–∞ 500,000 —Å—É–º",
  "order_amount": 500000
}

# 4. –ü—Ä–æ–ø—É—Å–∫ –≤–∏–∑–∏—Ç–∞ (–∫–ª–∏–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç)
PATCH /api/v1/planning/visits/{visit_id}
{
  "status": "skipped",
  "skip_reason": "client_closed",
  "notes": "–ú–∞–≥–∞–∑–∏–Ω –∑–∞–∫—Ä—ã—Ç –Ω–∞ —Ä–µ–º–æ–Ω—Ç"
}

# 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GPS –ª–æ–∫–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞
PATCH /api/v1/agents/{agent_id}/location
{
  "current_latitude": 41.320,
  "current_longitude": 69.275
}
```

---

## 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏

### –ë–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞
–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 18:00 —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–∫–∞–∑—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è 5 –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤.

### API Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 18:00        ‚îÇ     ‚îÇ 18:05        ‚îÇ     ‚îÇ 18:10        ‚îÇ
‚îÇ –ò–º–ø–æ—Ä—Ç –∏–∑ ERP‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ POST         ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ –ú–∞—Ä—à—Ä—É—Ç—ã     ‚îÇ
‚îÇ POST /bulk   ‚îÇ     ‚îÇ /optimize    ‚îÇ     ‚îÇ –≥–æ—Ç–æ–≤—ã       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ó–∞–ø—Ä–æ—Å—ã

```bash
# 1. –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ –∏–∑ ERP
POST /api/v1/bulk/orders
Headers:
  Idempotency-Key: erp-import-20240205-1800
{
  "orders": [
    {
      "external_id": "ERP-001",
      "client_external_id": "CLT-001",
      "weight_kg": 150,
      "volume_m3": 1.2,
      "time_window_start": "2024-02-06T09:00:00",
      "time_window_end": "2024-02-06T12:00:00",
      "priority": 8
    },
    {
      "external_id": "ERP-002",
      "client_external_id": "CLT-002",
      "weight_kg": 200,
      ...
    }
  ]
}

# –û—Ç–≤–µ—Ç:
{
  "successful": 45,
  "failed": 2,
  "duplicates": 0,
  "order_ids": ["uuid-1", "uuid-2", ...],
  "errors": [
    {"external_id": "ERP-999", "error": "Client not found"}
  ]
}

# 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
POST /api/v1/delivery/optimize
{
  "order_ids": ["uuid-1", "uuid-2", ...],
  "vehicle_ids": ["veh-1", "veh-2", "veh-3", "veh-4", "veh-5"],
  "date": "2024-02-06",
  "solver": "auto",
  "options": {
    "minimize_vehicles": true,
    "respect_time_windows": true,
    "max_route_duration_minutes": 600
  }
}

# –û—Ç–≤–µ—Ç:
{
  "optimization_id": "opt-123",
  "status": "completed",
  "solver_used": "vroom",
  "computation_time_ms": 1250,
  "routes": [
    {
      "id": "route-1",
      "vehicle_id": "veh-1",
      "vehicle_name": "–ì–∞–∑–µ–ª—å NN-001",
      "total_distance_km": 45.2,
      "total_duration_minutes": 180,
      "total_weight_kg": 1200,
      "utilization_percent": 80,
      "stops": [
        {
          "sequence": 1,
          "order_id": "uuid-1",
          "client_name": "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç –ú–∞–∫—Ä–æ",
          "address": "—É–ª. –ù–∞–≤–æ–∏ 100",
          "planned_arrival": "09:15",
          "planned_departure": "09:30",
          "weight_kg": 150
        },
        ...
      ]
    },
    ...
  ],
  "unassigned": [],
  "summary": {
    "routes_count": 4,
    "orders_assigned": 45,
    "total_distance_km": 180.5,
    "total_duration_minutes": 720,
    "average_utilization_percent": 75
  }
}

# 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ PDF
GET /api/v1/export/route/{route_id}
# ‚Üí PDF —Å –∫–∞—Ä—Ç–æ–π, —Å–ø–∏—Å–∫–æ–º –æ—Å—Ç–∞–Ω–æ–≤–æ–∫, –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
```

---

## 4. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ë–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞
–í 11:00 –∫–ª–∏–µ–Ω—Ç –æ—Ç–º–µ–Ω—è–µ—Ç –∑–∞–∫–∞–∑. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç.

### API Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 11:00        ‚îÇ     ‚îÇ –°–∏—Å—Ç–µ–º–∞      ‚îÇ     ‚îÇ –í–æ–¥–∏—Ç–µ–ª—å     ‚îÇ
‚îÇ –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ POST         ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ –ø–æ–ª—É—á–∞–µ—Ç     ‚îÇ
‚îÇ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞   ‚îÇ     ‚îÇ /reoptimize  ‚îÇ     ‚îÇ –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ó–∞–ø—Ä–æ—Å—ã

```bash
# 1. –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ (–∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ)
DELETE /api/v1/delivery/orders/{order_id}
# –∏–ª–∏
PATCH /api/v1/delivery/orders/{order_id}
{
  "status": "cancelled",
  "cancel_reason": "client_request"
}

# 2. –ü–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
POST /api/v1/delivery/routes/{route_id}/reoptimize
{
  "reason": "order_cancelled",
  "excluded_order_ids": ["cancelled-order-id"],
  "current_vehicle_location": {
    "latitude": 41.320,
    "longitude": 69.275
  }
}

# –û—Ç–≤–µ—Ç:
{
  "route_id": "route-1",
  "status": "reoptimized",
  "changes": {
    "stops_removed": 1,
    "stops_reordered": true,
    "distance_saved_km": 5.2,
    "time_saved_minutes": 15
  },
  "new_stops": [...],
  "affected_orders": ["order-2", "order-3"]
}

# 3. Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è ERP
# (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è)
POST https://your-erp.com/webhooks/sfa
{
  "event": "route.updated",
  "timestamp": "2024-02-06T11:05:00Z",
  "data": {
    "route_id": "route-1",
    "reason": "reoptimization",
    "changes": {...}
  }
}
```

---

## 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ERP

### –ë–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞
SmartUp/1C –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑—ã –≤ SFA-Routing –∏ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

### Webhook Events

| Event | –û–ø–∏—Å–∞–Ω–∏–µ | –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è |
|-------|----------|-------------------|
| `optimization.completed` | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ | –ü–æ—Å–ª–µ POST /optimize |
| `route.updated` | –ú–∞—Ä—à—Ä—É—Ç –∏–∑–º–µ–Ω—ë–Ω | –ü–æ—Å–ª–µ reoptimize |
| `visit.completed` | –í–∏–∑–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω | –ü–æ—Å–ª–µ PATCH visit |
| `delivery.completed` | –î–æ—Å—Ç–∞–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ | –ü–æ—Å–ª–µ –æ—Ç–º–µ—Ç–∫–∏ –≤–æ–¥–∏—Ç–µ–ª—è |

### –ó–∞–ø—Ä–æ—Å—ã

```bash
# 1. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
POST /api/v1/webhooks/subscribe
{
  "url": "https://erp.company.com/api/sfa-webhooks",
  "events": [
    "optimization.completed",
    "route.updated",
    "delivery.completed"
  ],
  "secret": "webhook-secret-key-min-32-characters"
}

# 2. –ü—Ä–∏–º–µ—Ä –≤—Ö–æ–¥—è—â–µ–≥–æ webhook –≤ ERP
POST https://erp.company.com/api/sfa-webhooks
Headers:
  X-Webhook-Signature: sha256=abc123...
  X-Webhook-Timestamp: 1707220500
{
  "event": "delivery.completed",
  "timestamp": "2024-02-06T14:35:00Z",
  "data": {
    "order_id": "uuid",
    "external_id": "ERP-001",
    "delivered_at": "2024-02-06T14:30:00Z",
    "signature_url": "https://cdn.../signature.png",
    "notes": "–ü—Ä–∏–Ω—è—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é"
  }
}

# 3. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (Python)
import hmac
import hashlib

def verify_signature(payload, signature, secret):
    expected = hmac.new(
        secret.encode(),
        payload,
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(f"sha256={expected}", signature)
```

---

## 6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ–ª–æ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –ë–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞
–î–∏—Å–ø–µ—Ç—á–µ—Ä –≤–∏–¥–∏—Ç –≤—Å–µ –º–∞—à–∏–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ, –ø–æ–ª—É—á–∞–µ—Ç –∞–ª–µ—Ä—Ç—ã –æ –∑–∞–¥–µ—Ä–∂–∫–∞—Ö.

### WebSocket Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ú–æ–±–∏–ª—å–Ω–æ–µ    ‚îÇ     ‚îÇ SFA-Routing  ‚îÇ     ‚îÇ –î–∏—Å–ø–µ—Ç—á–µ—Ä    ‚îÇ
‚îÇ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ WebSocket    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Dashboard    ‚îÇ
‚îÇ –≤–æ–¥–∏—Ç–µ–ª—è     ‚îÇ GPS ‚îÇ Hub          ‚îÇpush ‚îÇ (–∫–∞—Ä—Ç–∞)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ó–∞–ø—Ä–æ—Å—ã

```javascript
// 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –∫ WebSocket
const ws = new WebSocket('wss://api.example.com/ws/dispatcher');

ws.onopen = () => {
  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ –º–∞—à–∏–Ω—ã
  ws.send(JSON.stringify({
    type: 'subscribe',
    topics: ['fleet:all', 'alerts:delays']
  }));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.type === 'gps_update') {
    // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ
    updateVehicleMarker(data.vehicle_id, data.latitude, data.longitude);
  }

  if (data.type === 'delay_alert') {
    // –ü–æ–∫–∞–∑–∞—Ç—å –∞–ª–µ—Ä—Ç
    showAlert(`–ó–∞–¥–µ—Ä–∂–∫–∞: ${data.vehicle_name}, ${data.delay_minutes} –º–∏–Ω`);
  }
};

// 2. –û—Ç–ø—Ä–∞–≤–∫–∞ GPS –æ—Ç –≤–æ–¥–∏—Ç–µ–ª—è (–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
const driverWs = new WebSocket('wss://api.example.com/ws/driver/{vehicle_id}');

// –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
  navigator.geolocation.getCurrentPosition((pos) => {
    driverWs.send(JSON.stringify({
      type: 'gps_update',
      latitude: pos.coords.latitude,
      longitude: pos.coords.longitude,
      speed: pos.coords.speed,
      timestamp: new Date().toISOString()
    }));
  });
}, 30000);
```

### REST API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ–≥–æ —Ñ–ª–æ—Ç–∞
GET /api/v1/fleet/status

# –û—Ç–≤–µ—Ç:
{
  "total_vehicles": 10,
  "active": 8,
  "idle": 2,
  "vehicles": [
    {
      "id": "veh-1",
      "name": "–ì–∞–∑–µ–ª—å NN-001",
      "status": "en_route",
      "current_location": {
        "latitude": 41.320,
        "longitude": 69.275,
        "updated_at": "2024-02-06T11:30:00Z"
      },
      "current_route": {
        "id": "route-1",
        "progress_percent": 45,
        "completed_stops": 3,
        "remaining_stops": 4,
        "eta_completion": "2024-02-06T16:30:00Z"
      },
      "delay_minutes": 0
    },
    ...
  ]
}
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ KPI

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ API

```bash
GET /api/v1/analytics/kpi?date_from=2024-02-01&date_to=2024-02-29

{
  "period": "2024-02",
  "sfa_metrics": {
    "total_visits_planned": 1200,
    "total_visits_completed": 1080,
    "completion_rate": 90.0,
    "average_visits_per_agent": 12.5,
    "on_time_rate": 85.0
  },
  "delivery_metrics": {
    "total_orders": 2500,
    "total_delivered": 2450,
    "delivery_rate": 98.0,
    "average_route_distance_km": 45.2,
    "average_utilization": 78.5
  },
  "optimization_metrics": {
    "total_optimizations": 150,
    "average_computation_time_ms": 1200,
    "solver_usage": {
      "vroom": 120,
      "ortools": 25,
      "genetic": 5
    }
  }
}
```

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [API Reference](API_REFERENCE.md) - –ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ API
- [CLAUDE.md](../CLAUDE.md) - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [examples/](../examples/) - –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
